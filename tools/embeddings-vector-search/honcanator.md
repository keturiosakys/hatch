# Application Overview
This Hono application is a web service running on Cloudflare Workers, interacting with a PostgreSQL database and Cloudflare services like R2 and AI. It allows users to manage a collection of geese, including adding new ones, retrieving their details, and storing associated images generated by a text-to-image AI model.

# Code Snippets

## Snippet 1: Configure Drizzle ORM with PostgreSQL
### Description
This snippet demonstrates the configuration of Drizzle ORM for a PostgreSQL database using environment variables and a schema definition.

### Required Imports
```typescript
import { config } from "dotenv";
import { defineConfig } from "drizzle-kit";
```

### Code Example
```typescript
config({ path: "./.dev.vars" });

export default defineConfig({
  schema: "./src/db/schema.ts",
  out: "./drizzle",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL ?? "",
  },
});
```

### Tags
- Drizzle ORM
- PostgreSQL
- Configuration

## Snippet 2: Define PostgreSQL Table Schema
### Description
Defines the "geese" table schema using Drizzle ORM's pg-core module, illustrating how to structure a database table in TypeScript.

### Required Imports
```typescript
import { jsonb, pgTable, serial, text, timestamp } from "drizzle-orm/pg-core";
```

### Code Example
```typescript
export type NewGeese = typeof geese.$inferInsert;

export const geese = pgTable("geese", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

### Tags
- Database Schema
- PostgreSQL
- Drizzle ORM

## Snippet 3: Insert and Retrieve Geese Data with Hono and Drizzle
### Description
This snippet handles requests to add a new goose and retrieve existing geese records from the database, integrating with Cloudflare Workers' environment bindings.

### Required Imports
```typescript
import { Hono } from "hono";
import { drizzle } from "drizzle-orm/neon-http";
import { eq } from "drizzle-orm";
import { geese } from "./db/schema";
import { neon } from "@neondatabase/serverless";
```

### Code Example
```typescript
type Bindings = {
  DATABASE_URL: string;
  R2_BUCKET: R2Bucket;
  AI: Ai;
};

const app = new Hono<{ Bindings: Bindings }>();

app.post("/api/geese/:name", async (c) => {
  const { name } = c.req.param();
  const sql = neon(c.env.DATABASE_URL);
  const db = drizzle(sql);

  const maybeGoose = await db.select().from(geese).where(eq(geese.name, name));

  if (maybeGoose.length !== 0) {
    return c.json(
      {
        error: "already_exists",
      },
      400,
    );
  }

  const model = "@cf/black-forest-labs/flux-1-schnell" as BaseAiTextToImageModels;
  const prompt = `Please generate a image of a goose. Its name is ${name}. Make it in the style of comic or anime please`;

  const response = await c.env.AI.run(model, { prompt });
  const base64image = response.image;
  const buffer = Buffer.from(base64image, "base64");

  await c.env.R2_BUCKET.put(`${name}.png`, buffer);

  const [goose] = await db.insert(geese).values({ name }).returning();

  return c.json({ status: "OK", id: goose.id });
});

app.get("/api/geese", async (c) => {
  const sql = neon(c.env.DATABASE_URL);
  const db = drizzle(sql);

  return c.json({ geese: await db.select().from(geese) });
});
```

### Tags
- Database Operations
- Cloudflare Workers
- AI Integration
- Image Storage

## Snippet 4: Retrieve Goose Image and Data
### Description
Handles retrieving goose details and their stored image from Cloudflare R2, using Hono for routing and response handling.

### Required Imports
```typescript
import { Hono } from "hono";
import { drizzle } from "drizzle-orm/neon-http";
import { eq } from "drizzle-orm";
import { geese } from "./db/schema";
import { neon } from "@neondatabase/serverless";
```

### Code Example
```typescript
app.get("/api/geese/:name", async (c) => {
  const { name } = c.req.param();
  const sql = neon(c.env.DATABASE_URL);
  const db = drizzle(sql);

  const goose = await db.select().from(geese).where(eq(geese.name, name));

  if (goose.length === 0) {
    return c.json({ error: "doesnt_exist" }, 404);
  }

  const image = await c.env.R2_BUCKET.get(`${name}.png`);

  if (!image) {
    return c.json({ error: "image_not_found" }, 404);
  }

  c.header("Content-Type", "image/png");
  return c.body(image.body);
});
```

### Tags
- Image Retrieval
- Cloudflare R2
- API
- Image Response